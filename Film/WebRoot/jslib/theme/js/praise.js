/*! js weidian 2015-04-15 */
var Praise={WX_openid:M.getCookie("WX_openid"),clickStatus:0,maxShowUserIcon:0,maxUserIcon:200,hasLiked:!1,setCookie:function(){var a=M.urlQuery("ticket"),b=M.urlQuery("ticket_uid");a&&b&&M.get("/wd/account/ticket?param="+M.toJSON({uid:b,ticket:a}),function(a){0==a.status.status_code&&a.result&&(Praise.WX_openid=M.getCookie("WX_openid"))})},getStatus:function(){var a={from:"wechat",itemID:Item.itemID(),userID:Praise.WX_openid,limit:Praise.maxShowUserIcon,offset:0};Praise.clickStatus&&(a.limit=-1),M.jsonp("http://wd.koudai.com/wd/shop/getLikeInfo?param="+M.toJSON(a),function(a){if(0===Number(a.status.status_code)){var b=a.result;if(b&&b.list&&b.list.length){for(var c=b.list,d="",e=c.length,f=0,e=c.length;e>f&&f<Praise.maxUserIcon;f++)d+=' <em><img src="'+c[f].avatar+'"/></em>';e>Praise.maxUserIcon&&(d+='<em class="praiseEllipsis">...</em>'),$("#userimgList").html(d).show(),$("#praiseMore").hide(),Praise.clickStatus||$("#praiseBtn").html(b.total)}else $("#userimgList").hide();!Praise.clickStatus&&b&&b.list&&Number(b.total)>Praise.maxShowUserIcon&&($("#praiseMore").show(),$("#userimgList").addClass("praiseHasMore"),$("#praiseMore").bind("click",function(){Praise.clickStatus=1,$("#userimgList").removeClass("praiseHasMore"),Praise.getStatus()})),a.liked?(Praise.hasLiked=!0,$("#praiseBtn").addClass("praisedBtn")):Praise.hasLiked=!1}else M._alert(a.status.status_reason)})},allowPraise:function(){$("#praiseBtn").bind("click",function(){if(!M.isWeixin())return void M._alert("请在微信里面点赞");if(Praise.WX_openid){if(Praise.hasLiked)return void M._alert("你已经点过赞了");var a={from:"wechat",userID:Praise.WX_openid,itemID:Item.itemID()};M.jsonp("http://wd.koudai.com/wd/shop/like?param="+M.toJSON(a),function(a){0===Number(a.status.status_code)?Praise.getStatus():M._alert(a.status.status_reason)})}else{var b=window.location.href;location.href="http://login.koudai.com/wechat/auth?field=wd_h5_item_like&role=buyer&redirect="+encodeURIComponent(b)}})},init:function(){$("#item_other_info").show(),Praise.setCookie(),Praise.allowPraise(),Praise.maxShowUserIcon=2*Math.floor((screen.width-29)/41),Praise.getStatus()}};Praise.init();